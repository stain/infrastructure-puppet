---
classes:
  - apt::unattended_upgrades
  - apt::update
  - fail2ban_asf::config
  - rootbin_asf
  - rsync::server
  - rsync_bai_asf
  - s3fs
  - ssl::name::bai_stunnel
  - ssl::name::wildcard_apache_org
  - stunnel
  - zmanda_asf::install
  - zfs_on_ubuntu

rsync::package_ensure:        'latest'
rsync::server::use_xinetd:    false
rsync::server::gid:           'nogroup'

rsync::server::module:
  analysis-vm:
    path: '/x1/backups/analysis-vm/./target/'
    hosts_allow: '127.0.0.1 140.211.11.128'
    auth_users: 'apb-analysis-vm'
    secrets_file: '/etc/rsyncd.secrets'
  roller-vm:
    path: '/x1/backups/roller-vm/./target/'
    hosts_allow: '127.0.0.1 140.211.11.128'
    auth_users: 'apb-roller-vm'
    secrets_file: '/etc/rsyncd.secrets'
  mysql2-us-mid:
    path: '/x1/backups/mysql2-us-mid/./target/'
    hosts_allow: '127.0.0.1 23.253.172.122'
    auth_users: 'apb-mysql2-us-mid'
    secrets_file: '/etc/rsyncd.secrets'
  allura-vm:
    path: '/x1/backups/allura-vm/./target/'
    hosts_allow: '127.0.0.1 140.211.11.147'
    auth_users: 'apb-allura'
    secrets_file: '/etc/rsyncd.secrets'
  hermes:
    path: '/x1/backups/hermes/./target/'
    hosts_allow: '127.0.0.1 140.211.11.3'
    auth_users: 'apb-hermes'
    secrets_file: '/etc/rsyncd.secrets'

stunnel::tun:
  rsyncd:
    certificate:  '/etc/ssl/certs/bai.apache.org.crt'
    private_key:  '/etc/ssl/private/bai.apache.org.key'
    ca_file:      '/etc/ssl/certs/bai.apache.org.ca'
    crl_file:     '/etc/ssl/private/bai.apache.org.crl'
    chroot:       '/var/lib/stunnel4/rsyncd'
    user:         'stunnel4'
    group:        'nogroup'
    client:        false
    accept:        8443
    connect:       873
